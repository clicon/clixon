#
# ***** BEGIN LICENSE BLOCK *****
# 
# Copyright (C) 2009-2017 Olof Hagsand and Benny Holmgren
#
# This file is part of CLIXON
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# Alternatively, the contents of this file may be used under the terms of
# the GNU General Public License Version 3 or later (the "GPL"),
# in which case the provisions of the GPL are applicable instead
# of those above. If you wish to allow use of your version of this file only
# under the terms of the GPL, and not to allow others to
# use your version of this file under the terms of Apache License version 2, 
# indicate your decision by deleting the provisions above and replace them with
# the notice and other provisions required by the GPL. If you do not delete
# the provisions above, a recipient may use your version of this file under
# the terms of any one of the Apache License version 2 or the GPL.
#
# ***** END LICENSE BLOCK *****
#
prefix 		= @prefix@
datarootdir	= @datarootdir@
srcdir  	= @srcdir@
top_srcdir  	= @top_srcdir@
exec_prefix 	= @exec_prefix@
bindir 		= @bindir@
libdir		= @libdir@
dbdir		= @prefix@/db
mandir		= @mandir@
libexecdir	= @libexecdir@
localstatedir	= @localstatedir@
sysconfdir	= @sysconfdir@

SH_SUFFIX	= @SH_SUFFIX@
CLIXON_VERSION  = @CLIXON_VERSION@
CLIXON_MAJOR    = @CLIXON_VERSION_MAJOR@
CLIXON_MINOR    = @CLIXON_VERSION_MINOR@

VPATH       	= @srcdir@
CC		= @CC@
CFLAGS  	= -fPIC @CFLAGS@ 
LDFLAGS 	= @LDFLAGS@
LIBS    	= @LIBS@ 

YACC		= @YACC@
LEX		= @LEX@

CPPFLAGS  	= @CPPFLAGS@

INCLUDES = -I. @INCLUDES@ -I$(top_srcdir)/lib/clixon -I$(top_srcdir)/include -I$(top_srcdir)

SRC     = clixon_sig.c clixon_log.c clixon_err.c clixon_event.c clixon_proc.c \
	  clixon_string.c clixon_handle.c  \
	  clixon_xml.c clixon_xml_map.c clixon_file.c \
	  clixon_json.c clixon_yang.c clixon_yang_type.c \
	  clixon_hash.c clixon_options.c clixon_plugin.c \
	  clixon_proto.c clixon_proto_client.c \
	  clixon_xsl.c clixon_sha1.c clixon_xml_db.c

YACCOBJS := lex.clixon_xml_parse.o clixon_xml_parse.tab.o \
	    lex.clixon_yang_parse.o  clixon_yang_parse.tab.o \
	    lex.clixon_json_parse.o  clixon_json_parse.tab.o 


# Generated src 
GENSRC  = build.c 

OBJS    = $(YACCOBJS) $(SRC:.c=.o) 
GENOBJS  = $(GENSRC:.c=.o) 

# Linker-name: libclixon.so
# so-name: libclixon.so.2
# real-name: libclixon.so.2.0
MYLIB        = libclixon$(SH_SUFFIX).$(CLIXON_MAJOR).$(CLIXON_MINOR)
MYLIBSO      = libclixon$(SH_SUFFIX).$(CLIXON_MAJOR)
MYLIBLINK    = libclixon$(SH_SUFFIX)

all:	 $(MYLIB) $(MYLIBLINK)

clean:
	rm -f $(OBJS) $(MYLIB) $(MYLIBLINK) $(GENOBJS) $(GENSRC) *.core
	rm -f clixon_xml_parse.tab.[ch] clixon_xml_parse.yy.[co]
	rm -f clixon_yang_parse.tab.[ch] clixon_yang_parse.[co]
	rm -f clixon_json_parse.tab.[ch] clixon_json_parse.[co]
	rm -f lex.clixon_xml_parse.c
	rm -f lex.clixon_yang_parse.c
	rm -f lex.clixon_json_parse.c

#############################################################################
# Implicit rules for lex and yacc.
#
# lex files *.l -> *.yy.c
# yacc files *.y -> *.tab.c and *.tab.h
#
# Lex forces yacc include file *.tab.h to be built.
#############################################################################

%.c : %.y  # cancel implicit yacc rule
%.c : %.l  # cancel implicit lex rule

# xml parser
lex.clixon_xml_parse.c : clixon_xml_parse.l clixon_xml_parse.tab.h
	$(LEX) -Pclixon_xml_parse clixon_xml_parse.l # -d is debug

clixon_xml_parse.tab.c clixon_xml_parse.tab.h: clixon_xml_parse.y
	$(YACC) -l -d -p clixon_xml_parse clixon_xml_parse.y # -t is debug
	mv y.tab.c clixon_xml_parse.tab.c
	mv y.tab.h clixon_xml_parse.tab.h

lex.clixon_xml_parse.o : lex.clixon_xml_parse.c clixon_xml_parse.tab.h # special rule to for make clean to work
	$(CC) $(INCLUDES) $(CPPFLAGS) $(CFLAGS) -Wno-error -c $<

# yang parser
lex.clixon_yang_parse.c : clixon_yang_parse.l clixon_yang_parse.tab.h
	$(LEX) -Pclixon_yang_parse clixon_yang_parse.l # -d is debug

clixon_yang_parse.tab.c clixon_yang_parse.tab.h: clixon_yang_parse.y
	$(YACC) -l -d -p clixon_yang_parse clixon_yang_parse.y # -t is debug
	mv y.tab.c clixon_yang_parse.tab.c
	mv y.tab.h clixon_yang_parse.tab.h

lex.clixon_yang_parse.o : lex.clixon_yang_parse.c clixon_yang_parse.tab.h
	$(CC) $(INCLUDES) $(CPPFLAGS) $(CFLAGS) -Wno-error -c $<

# json parser
lex.clixon_json_parse.c : clixon_json_parse.l clixon_json_parse.tab.h
	$(LEX) -Pclixon_json_parse clixon_json_parse.l # -d is debug

clixon_json_parse.tab.c clixon_json_parse.tab.h: clixon_json_parse.y
	$(YACC) -l -d -p clixon_json_parse clixon_json_parse.y # -t is debug
	mv y.tab.c clixon_json_parse.tab.c
	mv y.tab.h clixon_json_parse.tab.h

lex.clixon_json_parse.o : lex.clixon_json_parse.c clixon_json_parse.tab.h
	$(CC) $(INCLUDES) $(CPPFLAGS) $(CFLAGS) -Wno-error -c $<

distclean: clean
	rm -f Makefile *~ .depend

.SUFFIXES:
.SUFFIXES: .c .o

.c.o: $(GENSRC)
	$(CC) $(INCLUDES) $(CPPFLAGS) $(CFLAGS) -c $<

.PHONY: build.c
build.c:	
	date +"const char CLIXON_BUILDSTR[64]=\"%Y.%m.%d %H:%M by `whoami` on `hostname`"\"\; > build.c;
	echo "const char CLIXON_VERSION[64]=\"$(CLIXON_VERSION)\""\; >> build.c;


$(MYLIB) : $(GENOBJS) $(OBJS) 
	$(CC) $(LDFLAGS) -shared -Wl,-soname,$(MYLIBSO) -o $@ $(GENOBJS) $(OBJS) $(LIBS) -Wl,-soname=$(MYLIBSO) 
# link-name is needed for application linking, eg for clixon_cli and clixon_config
$(MYLIBLINK) : $(MYLIB)
#	ln -sf $(MYLIB) $@

#	ar cru $@ $^
#	ranlib $@

install: install-lib

install-include:

install-lib: $(MYLIB)
	install -m 755 -d $(DESTDIR)$(libdir) 
	install -m 755 $(MYLIB) $(DESTDIR)$(libdir) 
	ln -sf $(MYLIB) $(DESTDIR)$(libdir)/$(MYLIBSO)     # -l:libclixon.so.3
	ln -sf $(MYLIBSO) $(DESTDIR)$(libdir)/$(MYLIBLINK) # -l:libclixon.so

uninstall: 
	rm -f $(libdir)/$(MYLIB)

TAGS:
	find . -name '*.[chyl]' -print | etags -

depend:
	$(CC) $(DEPENDFLAGS) @DEFS@ $(INCLUDES) $(CFLAGS) -MM $(SRC) > .depend

#include .depend

