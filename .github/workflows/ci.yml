name: Clixon CI

on:
  push:
    branches:
       - master
       - test-actions
  pull_request:
    branches: [ master ]

jobs:
  docker-alpine-test-fcgi-r:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./docker/test
    steps:
    - uses: actions/checkout@v4
    # 2) Inline of make test, but without configure
    - name: in-line clone
      run: git clone file://$(realpath ../..)
    - name: openconfig
      run: mkdir -p openconfig; cd openconfig ; git clone https://github.com/openconfig/public
    - name: yangmodels1
      run: mkdir -p yang/standard
    - name: yangmodels2
      run: (cd yang; git init;)
    - name: yangmodels3
      run: (cd yang; git remote add -f origin https://github.com/YangModels/yang)
    - name: yangmodels4
      run: (cd yang; git config core.sparseCheckout true)
    - name: yangmodels5
      run: (echo "standard/" >> yang/.git/info/sparse-checkout; echo "experimental/" >> yang/.git/info/sparse-checkout)
    - name: yangmodels6
      run: (cd yang; git pull origin main)
    - name: make docker fcgi
      run: sudo docker build -f Dockerfile.fcgi -t clixon/clixon-test  .
    - name: start container
      run: ./start.sh
    - name: run test r-y
      run: sudo docker exec -t clixon-test bash -c 'cd /usr/local/bin/test && detail=true pattern="test_restconf_basic_auth.sh test_restconf_callhome.sh test_restconf_continue.sh test_restconf_internal.sh test_restconf_internal_usecases.sh" ./sum.sh'
